<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Halftone Dots — v8 (white dots, ×4 upscale)</title>
<style>
  :root { color-scheme: light dark; }
  body {
    margin: 0;
    font-family: system-ui, Arial, sans-serif;
    display: grid;
    grid-template-columns: 320px 1fr;
    min-height: 100vh;
  }
  aside {
    padding: 16px;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  main {
    position: relative;
    display: grid;
    place-items: center;
    background: rgba(0,0,0,0.25); /* затемнение */
  }
  canvas {
    max-width: 100%;
    max-height: 100vh;
    background: transparent;
  }
  h1 { font-size: 18px; margin: 0 0 8px; }
  .row { display: flex; align-items: center; gap: 8px; }
  .row input[type="range"] { width: 100%; }
  .hint { font-size: 12px; opacity: .75; }
  button { padding: 10px 12px; font-weight: 600; cursor: pointer; }
  .num { font-variant-numeric: tabular-nums; min-width: 48px; text-align: right; }
  label { display: grid; gap: 4px; }
</style>
</head>
<body>
  <aside>
    <h1>Halftone Dots</h1>

    <label>
      <b>1) Загрузите картинку</b>
      <input id="file" type="file" accept="image/*">
      <div class="hint">Альфа-канал используется как маска. Вывод в 4× большем размере.</div>
    </label>

    <label>
      <b>Шаг решётки (px)</b>
      <div class="row">
        <input id="cell" type="range" min="3" max="64" step="1" value="8">
        <span class="num" id="cellVal">8</span>
      </div>
    </label>

    <label>
      <b>Радиус кружков (px)</b>
      <div class="row">
        <input id="radius" type="range" min="1" max="32" step="0.5" value="3">
        <span class="num" id="radiusVal">3.0</span>
      </div>
    </label>

    <label>
      <b>Gamma</b>
      <div class="row">
        <input id="gamma" type="range" min="0.8" max="3.0" step="0.05" value="2.2">
        <span class="num" id="gammaVal">2.20</span>
      </div>
    </label>

    <label class="row" style="margin-top:6px;">
      <input id="blackBg" type="checkbox">
      <span>Сохранять с чёрным фоном</span>
    </label>

    <div class="row" style="justify-content: space-between; margin-top: 8px;">
      <button id="download" disabled>Download PNG</button>
      <button id="reset" disabled>Сброс</button>
    </div>

    <p class="hint">Масштаб вывода ×4, пропорции оригинала сохраняются. Альфа прозрачность не теряется.</p>
  </aside>

  <main>
    <canvas id="c"></canvas>
  </main>

<script>
// ---------- WebGL2 setup ----------
const canvas = document.getElementById('c');
const gl = canvas.getContext('webgl2', { antialias: false, alpha: true, premultipliedAlpha: false, preserveDrawingBuffer: true });
if (!gl) { alert('Нужен браузер с поддержкой WebGL2'); }

const vsSrc = `#version 300 es
precision highp float;
out vec2 vUV;
void main(){
  const vec2 pos[3]=vec2[3](vec2(-1.0,-1.0),vec2(3.0,-1.0),vec2(-1.0,3.0));
  vUV=pos[gl_VertexID]*0.5+0.5;
  gl_Position=vec4(pos[gl_VertexID],0.0,1.0);
}`;

const fsSrc = `#version 300 es
precision highp float;

uniform sampler2D uImage;
uniform vec2  uResolution;
uniform float uCell;
uniform float uRadius;
uniform float uGamma;

in vec2  vUV;
out vec4 fragColor;

float luma(vec3 c){ return dot(c, vec3(0.2126,0.7152,0.0722)); }
float bayer4(ivec2 ip){
  int x=ip.x&3; int y=ip.y&3; int idx=y*4+x;
  const int t[16]=int[16](0,8,2,10,12,4,14,6,3,11,1,9,15,7,13,5);
  return (float(t[idx])+0.5)/16.0;
}

void main(){
  vec2 fragPx=gl_FragCoord.xy;
  vec2 cellIdxF=floor(fragPx/uCell);
  ivec2 cellIdx=ivec2(cellIdxF);
  vec2 centerPx=(cellIdxF+0.5)*uCell;
  vec2 centerUV=centerPx/uResolution;
  vec4 srcC=texture(uImage,centerUV);
  float Y=luma(pow(srcC.rgb,vec3(1.0/max(uGamma,0.0001))));
  float threshold=bayer4(cellIdx);
  float on=step(1.0-Y,threshold);
  vec2 local=fragPx-centerPx;
  float d=length(local);
  float edge=1.0-smoothstep(uRadius-1.0,uRadius,d);
  float maskA=texture(uImage,vUV).a;
  float alpha=on*edge*maskA;
  fragColor=vec4(1.0,1.0,1.0,alpha);
}`;

function makeShader(type,src){const sh=gl.createShader(type);gl.shaderSource(sh,src);gl.compileShader(sh);
 if(!gl.getShaderParameter(sh,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(sh);return sh;}
function makeProgram(vs,fs){const p=gl.createProgram();gl.attachShader(p,vs);gl.attachShader(p,fs);gl.linkProgram(p);
 if(!gl.getProgramParameter(p,gl.LINK_STATUS))throw gl.getProgramInfoLog(p);return p;}

const program=makeProgram(makeShader(gl.VERTEX_SHADER,vsSrc),makeShader(gl.FRAGMENT_SHADER,fsSrc));
gl.useProgram(program);
const loc={uImage:gl.getUniformLocation(program,'uImage'),uResolution:gl.getUniformLocation(program,'uResolution'),
uCell:gl.getUniformLocation(program,'uCell'),uRadius:gl.getUniformLocation(program,'uRadius'),uGamma:gl.getUniformLocation(program,'uGamma')};
gl.bindVertexArray(gl.createVertexArray());
const tex=gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D,tex);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);

const $=id=>document.getElementById(id);
const cell=$('cell'),radius=$('radius'),gamma=$('gamma');
const cellVal=$('cellVal'),radiusVal=$('radiusVal'),gammaVal=$('gammaVal');
const file=$('file'),btnDownload=$('download'),btnReset=$('reset'),blackBg=$('blackBg');
function sync(){cellVal.textContent=cell.value;radiusVal.textContent=radius.value;gammaVal.textContent=Number(gamma.value).toFixed(2);}
sync();
[cell,radius,gamma].forEach(e=>e.addEventListener('input',()=>{sync();draw();}));
btnReset.addEventListener('click',()=>{cell.value=8;radius.value=3;gamma.value=2.2;sync();draw();});

let img=new Image(),imgLoaded=false;
img.onload=()=>{imgLoaded=true;renderUpscaled();};
file.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;img.src=URL.createObjectURL(f);});

function renderUpscaled(){
 const scale=4.0;
 const w=Math.floor(img.naturalWidth*scale);
 const h=Math.floor(img.naturalHeight*scale);
 canvas.width=w;canvas.height=h;
 gl.viewport(0,0,w,h);
 gl.bindTexture(gl.TEXTURE_2D,tex);
 gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);
 gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA8,gl.RGBA,gl.UNSIGNED_BYTE,img);
 gl.generateMipmap(gl.TEXTURE_2D);
 btnDownload.disabled=false;btnReset.disabled=false;
 draw();
}

function draw(){
 if(!imgLoaded)return;
 gl.viewport(0,0,canvas.width,canvas.height);
 gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);
 gl.useProgram(program);
 gl.uniform1i(loc.uImage,0);
 gl.activeTexture(gl.TEXTURE0);
 gl.bindTexture(gl.TEXTURE_2D,tex);
 gl.uniform2f(loc.uResolution,canvas.width,canvas.height);
 gl.uniform1f(loc.uCell,Number(cell.value));
 gl.uniform1f(loc.uRadius,Number(radius.value));
 gl.uniform1f(loc.uGamma,Number(gamma.value));
 gl.drawArrays(gl.TRIANGLES,0,3);
}

btnDownload.addEventListener('click',()=>{
 if(!imgLoaded)return;
 gl.finish();
 const w=canvas.width,h=canvas.height;
 const pixels=new Uint8Array(w*h*4);
 gl.readPixels(0,0,w,h,gl.RGBA,gl.UNSIGNED_BYTE,pixels);
 const out=document.createElement('canvas');
 out.width=w;out.height=h;
 const ctx=out.getContext('2d');
 const imgData=ctx.createImageData(w,h);
 const dst=imgData.data;
 for(let y=0;y<h;y++){
   for(let x=0;x<w;x++){
     const si=((h-1-y)*w+x)*4,di=(y*w+x)*4;
     let r=pixels[si],g=pixels[si+1],b=pixels[si+2],a=pixels[si+3];
     if(blackBg.checked){const af=a/255;r=Math.round(r*af);g=Math.round(g*af);b=Math.round(b*af);a=255;}
     dst[di]=r;dst[di+1]=g;dst[di+2]=b;dst[di+3]=a;
   }
 }
 ctx.putImageData(imgData,0,0);
 const url=out.toDataURL('image/png');
 const a=document.createElement('a');a.href=url;a.download='halftone_dots_upscaled.png';a.click();
});
</script>
</body>
</html>


